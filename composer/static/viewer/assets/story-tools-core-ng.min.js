!function(){"use strict";function e(){this.storyBoxes=[],this.map=null}var t=angular.module("storytools.core.boxes",[]),r=storytools.core.maps.boxes;e.prototype.boxesChanged=function(e,t){var r;if("delete"==t){for(r=0;r<e.length;r++)for(var o=e[r],n=0,a=this.storyBoxes.length;a>n;n++)if(this.storyBoxes[n].id==o.id){this.storyBoxes.splice(n,1);break}}else if("add"==t)for(r=0;r<e.length;r++)this.storyBoxes.push(e[r]);else if("change"!=t)throw new Error("action? :"+t);var i=this.storyBoxes.map(function(e){return e.range});this.map.storyBoxesLayer.set("times",i),this.map.storyBoxesLayer.set("features",this.storyBoxes)},e.prototype.loadFromGeoJSON=function(e,t,o){if(o&&(this.storyBoxes=[]),e&&e.features){var n=r.loadFromGeoJSON(e,t);this.boxesChanged(n,"add",!0)}},t.service("StoryBoxLayerManager",e),t.constant("StoryBox",r.Box)}(),function(){"use strict";var e=angular.module("storytools.core.legend.directives",[]),t=!1;e.directive("stLegend",["$rootScope","MapManager",function(e,r){return{restrict:"C",replace:!0,templateUrl:"legend/legend.html",link:function(e){e.mapManager=r;var o=function(){angular.element(document.getElementById("legend-container"))[0].style.visibility="visible",angular.element(document.getElementById("legend-panel"))[0].style.display="block",t=!0},n=function(){angular.element(document.getElementById("legend-panel"))[0].style.display="none",t=!1,setTimeout(function(){angular.element("#legend-container")[0].style.visibility="hidden"},350)};e.toggleLegend=function(){t===!1?(console.log(angular.element(document.getElementsByClassName("legend-item"))),o()):n()},e.getLegendUrl=function(e){var t=null,r="/geoserver/wms",o=e.get("typeName")||e.get("id");return t=r+"?request=GetLegendGraphic&format=image%2Fpng&width=20&height=20&layer="+o+"&transparent=true&legend_options=fontColor:0xFFFFFF;fontAntiAliasing:true;fontSize:14;fontStyle:bold;"},e.$on("layer-added",function(){t===!1&&o()}),e.$on("layerRemoved",function(){t===!0&&1==angular.element(".legend-item").length&&n()})}}}])}(),function(){"use strict";angular.module("storytools.core.legend",["storytools.core.legend.directives"])}(),function(){"use strict";angular.module("storytools.core.mapstory",["storytools.core.mapstory.services"])}(),function(){"use strict";function e(e){function t(e){var t="";return goog.isDefAndNotNull(e)&&(e.properties?t="feature":e.features?t="layer":e.length&&e[0].features&&(t="layers")),console.log(t),t}ol.Object.call(this,e),this.map_=new ol.Map({target:e.target,pixelRatio:1,controls:ol.control.defaults().extend([new ol.control.MousePosition({projection:"EPSG:4326",coordinateFormat:ol.coordinate.toStringHDMS}),new ol.control.ScaleLine({className:"metric-scale-line ol-scale-line",units:ol.control.ScaleLineUnits.METRIC}),new ol.control.ScaleLine({className:"imperial-scale-line ol-scale-line",units:ol.control.ScaleLineUnits.IMPERIAL}),l])}),this.overlay=new ol.layer.Vector({map:this.map_,style:i}),this.map_.addOverlay(new ol.Overlay({element:e.overlayElement||document.getElementById("feature-info"),stopEvent:!0})),this.title="Default Mapstory",this.abstract="No Information Supplied.",this.owner="",this.mode="instant",this.returnToExtent=e.returnToExtent||!1,this.center=[0,0],this.zoom=2,this.storyLayers_=new ol.Collection,this.animationDuration_=e.animationDuration||500,this.storyBoxesLayer=new r({timeAttribute:"start_time",endTimeAttribute:"end_time",layer:new ol.layer.Vector({source:new ol.source.Vector,style:i})}),this.storyPinsLayer=new r({timeAttribute:"start_time",endTimeAttribute:"end_time",layer:new ol.layer.Vector({source:new ol.source.Vector,style:i})}),this.addStoryPinsLayer(),this.addStoryBoxesLayer(),this.state_="",this.position_=null,this.show=function(e,r){if(!goog.isDefAndNotNull(e))return!1;var o=p,n=t(e);if(0===u.length)if("feature"===n)u.push({features:[e],layer:g});else if("layer"===n)u.push(e);else{if("layers"!==n)throw{name:"featureInfoBox",level:"High",message:"Expected layers, layer, or feature.",toString:function(){return this.name+": "+this.message}};u=e}if("feature"===n)c="feature",p=e;else if("layer"===n)1===e.features.length?(c="feature",p=e.features[0]):(c="layer",p=e);else{if("layers"!==n)throw{name:"featureInfoBox",level:"High",message:"Invalid item passed in. Expected layers, layer, or feature.",toString:function(){return this.name+": "+this.message}};1===e.length?1===e[0].features.length?(c="feature",p=e[0].features[0]):(c="layer",p=e[0]):(c="layers",p=e)}if(p!==o&&"feature"===t(p)){g=self.getSelectedItemLayer().layer;var a={},i=[];goog.object.forEach(p.properties,function(e,t){a[t]=[t,e]});var s=null;for(s in a)a.hasOwnProperty(s)&&i.push(a[s]);m=i,console.log("---- selectedItemProperties_: ",m)}goog.isDefAndNotNull(r)&&(f=r,self.storyMap.getMap().getOverlays().array_[0].setPosition(r))},this.getSelectedItemLayer=function(){for(var e=0;e<u.length;e++)for(var t=0;t<u[e].features.length;t++)if(console.log(u[e].features[t]===p),console.log(u[e].features[t]),console.log(p),u[e].features[t].id===p.id)return u[e];return null},this.showPreviousState=function(){self.show(self.getPreviousState().item)},this.getPreviousState=function(){var e=null,t=null;if("feature"===c){var r=self.getSelectedItemLayer();if(!r)throw{name:"featureInfoBox",level:"High",message:"Could not find feature!",toString:function(){return this.name+": "+this.message}};r.features.length>1?(e="layer",t=r):1===r.features.length&&u.length>1&&(t=u,e="layers")}else"layer"===c&&u.length>1&&(e="layers",t=u);return null!==t?{state:e,item:t}:""},this.getState=function(){return c},this.getSelectedItem=function(){return p},this.getMediaUrl=function(e){var t=e;return goog.isString(e)&&-1===e.indexOf("http")&&(t=configService_.configuration.fileserviceUrlTemplate.replace("{}",e)),t},this.getSelectedItemMedia=function(){return y},this.getSelectedItemMediaByProp=function(e){var r=null;return"feature"===t(p)&&goog.isDefAndNotNull(p)&&goog.isDefAndNotNull(m)&&goog.object.forEach(m,function(t){service_.isMediaPropertyName(t[0])&&(goog.isDefAndNotNull(e)&&e!==t[0]||(goog.isDefAndNotNull(r)||(r=[]),goog.object.forEach(t[1],function(e){r.push(e)})))}),r},this.isMediaPropertyName=function(e){var t=e.toLowerCase();return 0===t.indexOf("fotos")||0===t.indexOf("photos")||0===t.indexOf("audios")||0===t.indexOf("videos")},this.getMediaTypeFromPropertyName=function(e){var t=e.toLowerCase(),r=null;return 0===t.indexOf("fotos")||0===t.indexOf("photos")?r="photos":0===t.indexOf("audios")?r="audios":0===t.indexOf("videos")&&(r="videos"),r},this.getMediaUrlThumbnail=function(e){var t=e;if(goog.isDefAndNotNull(e)&&"string"==typeof e){var r=e.split(".").pop().split("/")[0];t=supportedVideoFormats_.indexOf(r)>=0?service_.getMediaUrlDefault():service_.getMediaUrl(e)}return t},this.getMediaUrlDefault=function(){return"/static/maploom/assets/media-default.png"},this.getMediaUrlError=function(){return"/static/maploom/assets/media-error.png"},this.getSelectedItemProperties=function(){return m},this.setSelectedItemProperties=function(e){m=e},this.getSelectedLayer=function(){return g},this.getPosition=function(){return f},this.getEnabled=function(){return s},this.hide=function(){p=null,y=null,m=null,c=null,u=[],this.map_.getMap().getOverlays().array_[0].setPosition(void 0)}}function t(t){e.call(this,t)}function r(e){var t={};e.times&&storytools.core.time.utils.isRangeLike(e.times)&&(e.times=new storytools.core.time.utils.Interval(e.times)),ol.Object.call(this,e);var r;if("VECTOR"===this.get("type")){var o=new ol.source.Vector({});if(e.cluster){var n=new ol.source.Cluster({distance:20,source:o});t={source:n,style:e.style||i}}else t={source:o,style:e.style||i};r=new ol.layer.Vector(t),e.animate&&window.setInterval(function(){o.dispatchEvent("change")},1e3/75)}else if("HEATMAP"===this.get("type"))r=new ol.layer.Heatmap({radius:e.style.radius,opacity:e.style.opacity,source:new ol.source.Vector});else if("WMS"===this.get("type")){var a={useOldAsInterimTiles:!0};r=this.get("singleTile")===!0?new ol.layer.Image(a):new ol.layer.Tile(a)}else r=e.layer;this.layer_=r}function o(e){r.call(this,e)}function n(e,t,r){e.getMap().on("singleclick",function(o){goog.isDefAndNotNull(d)||(d=e.getMap().getOverlays().array_[0].getElement(),r(d)(t)),self.hide(),u=[],p=null,y=null,m=null,c=null;var n=[],a=e.getMap().getView(),i=e.getStoryLayers().getArray(),s=0,l=0;goog.array.forEach(i,function(e){var t=e.getLayer().getSource();goog.isDefAndNotNull(t.getGetFeatureInfoUrl)&&s++});var g=function(){if(l++,l===s){if(n.length>0){var e=o.coordinate;self.show(n,e)}}else self.hide(),p=null,y=null,m=null,c=null,u=[]};goog.array.forEach(i,function(e,t){var r=e.getLayer().getSource();if(goog.isDefAndNotNull(r.getGetFeatureInfoUrl)){var s=r.getGetFeatureInfoUrl(o.coordinate,a.getResolution(),a.getProjection(),{INFO_FORMAT:"application/json",FEATURE_COUNT:5});$http.get(s).then(function(e){var r={};r.features=e.data.features,r.features&&r.features.length>0&&goog.isDefAndNotNull(i[t])&&(r.layer=i[t],goog.array.insert(n,r)),g()},function(){g()})}}),g()})}var a=angular.module("storytools.core.ogc",[]),i=[new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:1}),image:new ol.style.Circle({radius:10,fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:1})})})],s=!0;$("#map .metric-scale-line").css("bottom","-=40px"),$("#map .imperial-scale-line").css("bottom","-=40px"),$("#map .nautical-scale-line").css("bottom","-=40px"),$("#map .ol-mouse-position").css("bottom","-=40px"),$("#switch-coords-border").css("bottom","-=40px");var l=new ol.control.ScaleLine({className:"nautical-scale-line ol-scale-line",units:ol.control.ScaleLineUnits.NAUTICAL,render:function(e){var t=e.frameState;this.viewState_=t?t.viewState:null;var r=this.viewState_;if(!r)return void(this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1));var o=r.center,n=r.projection,a=n.getMetersPerUnit(),i=n.getPointResolution(r.resolution,o)*a;i/=1852;var s="nm",l=20,u=Math.round(l/i),c=l+" "+s;return this.renderedHTML_!=c&&(this.innerElement_.innerHTML=c,this.renderedHTML_=c),u>.6*e.frameState.size[0]||15>u?(this.element_.style.display="none",void(this.renderedVisible_=!1)):(this.renderedWidth_!=u&&(this.innerElement_.style.width=u+"px",this.renderedWidth_=u),void(this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0)))}});e.prototype=Object.create(ol.Object.prototype),e.prototype.constructor=e,e.prototype.addStoryPinsLayer=function(){this.map_.addLayer(this.storyPinsLayer.getLayer())},e.prototype.addStoryBoxesLayer=function(){this.map_.addLayer(this.storyBoxesLayer.getLayer())},e.prototype.setStoryOwner=function(e){this.owner=e},e.prototype.getStoryOwner=function(){return this.owner},e.prototype.getCenter=function(){return this.center},e.prototype.getZoom=function(){return this.zoom},e.prototype.setStoryTitle=function(e){this.title=e},e.prototype.setCenter=function(e){this.center=e},e.prototype.setZoom=function(e){this.zoom=e},e.prototype.setMode=function(e){this.mode=e},e.prototype.setStoryAbstract=function(e){this.abstract=e},e.prototype.getStoryTitle=function(){return this.title},e.prototype.getStoryAbstract=function(){return this.abstract},e.prototype.setBaseLayer=function(e){this.set("baselayer",e),this.map_.getLayers().forEach(function(e){"background"===e.get("group")&&this.map_.removeLayer(e)},this),this.map_.getLayers().insertAt(0,this.get("baselayer"))},e.prototype.addStoryLayer=function(e){e.storyMap_=this,this.storyLayers_.push(e);var t=this.map_.getLayers().getLength(),r=this;this.map_.getLayers().forEach(function(e){(e===r.storyPinsLayer||e instanceof ol.layer.Vector)&&(t-=1)}),this.map_.getLayers().insertAt(t,e.getLayer())},e.prototype.getStoryLayers=function(){return this.storyLayers_},e.prototype.getMap=function(){return this.map_},e.prototype.clear=function(){this.map_.getLayers().clear(),this.storyLayers_.clear(),this.addStoryPinsLayer()},e.prototype.animatePanAndBounce=function(e,t){var r=2e3,o=+new Date,n=this.map_.getView();if(n.getCenter()!=e){var a=ol.animation.pan({duration:this.animationDuration_,source:n.getCenter(),start:o}),i=ol.animation.bounce({duration:r,resolution:2*n.getResolution(),start:o});this.map_.beforeRender(a,i),n.setCenter(e),n.setZoom(t)}},e.prototype.animateCenterAndZoom=function(e,t){var r=this.map_.getView();(r.getCenter()!==e||r.getZoom()!==t)&&(this.map_.beforeRender(ol.animation.pan({duration:this.animationDuration_,source:r.getCenter()})),r.setCenter(e),this.map_.beforeRender(ol.animation.zoom({resolution:r.getResolution(),duration:this.animationDuration_})),r.setZoom(t))},e.prototype.setAllowPan=function(e){this.map_.getInteractions().forEach(function(t){(t instanceof ol.interaction.KeyboardPan||t instanceof ol.interaction.DragPan)&&t.setActive(e)})},e.prototype.setAllowZoom=function(e){var t;this.map_.getControls().forEach(function(e){e instanceof ol.control.Zoom&&(t=e)}),e?this.map_.addControl(new ol.control.Zoom):this.map_.removeControl(t),this.map_.getInteractions().forEach(function(t){(t instanceof ol.interaction.DoubleClickZoom||t instanceof ol.interaction.PinchZoom||t instanceof ol.interaction.DragZoom||t instanceof ol.interaction.MouseWheelZoom)&&t.setActive(e)})},e.prototype.toggleStoryLayer=function(e){var t=e.getLayer();e.set("visibility",!t.getVisible()),t.setVisible(!t.getVisible())},a.constant("StoryMap",e),t.prototype=Object.create(e.prototype),t.prototype.constructor=t,a.constant("EditableStoryMap",t),t.prototype.getState=function(){var e={};e.map={center:this.map_.getView().getCenter(),projection:this.map_.getView().getProjection().getCode(),zoom:this.map_.getView().getZoom(),layers:[]};var t=this.get("id");t>=0&&(e.id=t);var r=this.get("baselayer");if(r){var o=this.get("baselayer").get("state");o.group="background",o.visibility=!0,e.map.layers.push(o)}return this.storyLayers_.forEach(function(t){e.map.layers.push(t.getState())}),e},t.prototype.removeStoryLayer=function(e){this.storyLayers_.remove(e),this.map_.removeLayer(e.getLayer())},r.prototype=Object.create(ol.Object.prototype),r.prototype.constructor=r,r.prototype.getStoryMap=function(){return this.storyMap_},r.prototype.setWMSSource=function(){var e=this.getLayer(),t=this.get("name"),r=this.get("times"),o=this.get("singleTile"),n=this.get("params")||{LAYERS:t,VERSION:"1.1.0",TILED:!0};if(r&&(n.TIME=new Date(r.start||r[0]).toISOString()),o)e.setSource(new ol.source.ImageWMS({params:n,url:this.get("url"),serverType:"geoserver"}));else{var a,i=this.get("resolutions"),s=this.get("bbox");i&&s&&(a=new ol.tilegrid.TileGrid({extent:s,resolutions:i})),e.setSource(new ol.source.TileWMS({url:this.get("url"),params:n,tileGrid:a,serverType:"geoserver"}))}},r.prototype.getState=function(){var e=this.getProperties();return delete e.features,e},r.prototype.getLayer=function(){return this.layer_},r.prototype.setLayer=function(e){if(this.layer_&&this.storyMap_){var t=this.storyMap_.map_,r=t.getLayers().getArray().indexOf(this.layer_);t.getLayers().setAt(r,e)}this.layer_=e},a.constant("StoryLayer",r),o.prototype=Object.create(r.prototype),o.prototype.constructor=o,a.constant("EditableStoryLayer",o),a.service("stAnnotateLayer",["$rootScope","$http","$q",function(e,t,r){return{loadCapabilities:function(r){var o="GetCapabilities",n="WMS",a=r.get("url");if("/geoserver/wms"===a){var i=r.get("name"),s=i.split(":");a=a.replace("/geoserver","/geoserver/"+s[0]+"/"+s[1])}return a=a.replace("http:",""),e.$broadcast("layer-status",{name:r.get("name"),phase:"capabilities",status:"loading"}),t({method:"GET",url:a,params:{REQUEST:o,SERVICE:n,VERSION:"1.3.0",TILED:!0}}).then(function(t){var o=new owsjs.Jsonix.Context([owsjs.mappings.XLink_1_0,owsjs.mappings.WMS_1_3_0]),n=o.createUnmarshaller(),a=n.unmarshalString(t.data),i=a.value.capability.layer;r.set("latlonBBOX",[parseFloat(i.boundingBox[0].minx),parseFloat(i.boundingBox[0].miny),parseFloat(i.boundingBox[0].maxx),parseFloat(i.boundingBox[0].maxy)]);for(var s=a.value.capability.vendorSpecificCapabilities,l=s?s.tileSet||[]:[],u=0,c=l.length;c>u;++u)if("EPSG:900913"===l[u].srs){r.set("resolutions",l[u].resolutions.split(" "));var p=l[u].boundingBox;r.set("bbox",[parseFloat(p.minx),parseFloat(p.miny),parseFloat(p.maxx),parseFloat(p.maxy)]);break}var y=storytools.core.time.maps.readCapabilitiesTimeDimensions(a),g=r.get("name");g in y&&r.set("times",y[g]),e.$broadcast("layer-status",{name:r.get("name"),phase:"capabilities",status:"done"})}).catch(function(){})},describeFeatureType:function(r){var o=this,n="DescribeFeatureType",a="WFS",i=r.get("id");return e.$broadcast("layer-status",{name:r.get("name"),phase:"featureType",status:"loading"}),t({method:"GET",url:r.get("url").replace("http:",""),params:{SERVICE:a,VERSION:"1.0.0",REQUEST:n,TYPENAME:i}}).then(function(t){var n=storytools.edit?new storytools.edit.WFSDescribeFeatureType.WFSDescribeFeatureType:null;if(n){var a=n.parseResult(t.data);a.timeAttribute?r.set("timeAttribute",a.timeAttribute):r.get("timeEndpoint")&&o.getTimeAttribute(r);var s=i.split(":");r.set("typeName",i),r.set("featurePrefix",s[0]),r.set("featureNS",a.featureNS),r.set("geomType",a.geomType),r.set("attributes",a.attributes)}e.$broadcast("layer-status",{name:r.get("name"),phase:"featureType",status:"done"})}).catch(function(){})},getTimeAttribute:function(e){return t({method:"GET",url:e.get("timeEndpoint")}).then(function(t){e.set("timeAttribute",t.data.attribute),data.endAttribute&&e.set("endTimeAttribute",t.data.endAttribute)}).catch(function(){})},getStyleName:function(e){if(e.get("canStyleWMS")){return t({method:"GET",url:e.get("path")+"rest/layers/"+e.get("id")+".json"}).then(function(t){e.set("styleName",t.data.layer.defaultStyle.name)}).catch(function(){})}return r.when("")},getFeatures:function(r,o){var n=r.get("id"),a=r.get("cql"),i=r.get("url")+"?service=WFS&version=1.1.0&request=GetFeature&typename="+n+"&outputFormat=application/json&srsName="+o.getView().getProjection().getCode();return a&&(i+="&cql_filter="+a),i+="&t="+(new Date).getTime(),e.$broadcast("layer-status",{name:r.get("name"),phase:"features",status:"loading"}),t({method:"GET",url:i}).then(function(t){var o=r.getLayer(),n=r.get("filter"),a=(new ol.format.GeoJSON).readFeatures(t.data);n&&(a=n(a)),r.set("features",a),o.getSource()instanceof ol.source.Cluster?(o.getSource().getSource().clear(!0),o.getSource().getSource().addFeatures(a)):o.getSource()instanceof ol.source.Vector&&(o.getSource().clear(!0),o.getSource().addFeatures(a)),e.$broadcast("layer-status",{name:r.get("name"),phase:"features",status:"done"})}).catch(function(){})}}}]),a.service("stBaseLayerBuilder",function(){return{buildLayer:function(e){if("MapQuest"===e.type)return new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background",source:new ol.source.MapQuest({layer:e.layer})});if("ESRI"===e.type)return new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background",source:new ol.source.XYZ({attributions:[new ol.Attribution({html:'Tiles &copy; <a href="//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer">ArcGIS</a>'})],url:"//server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}"})});if("HOT"===e.type)return new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'Tiles courtesy of <a href="//hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'}),ol.source.OSM.ATTRIBUTION],crossOrigin:null,url:"//{a-c}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"})});if("OSM"===e.type)return new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background",source:new ol.source.OSM});if("MapBox"===e.type){var t=new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background"}),r=e.name,o=["//a.tiles.mapbox.com/v1/mapbox.","//b.tiles.mapbox.com/v1/mapbox.","//c.tiles.mapbox.com/v1/mapbox.","//d.tiles.mapbox.com/v1/mapbox."],n=function(e){var t=e;return t[1]<0||t[2]<0?"":o[Math.round(3*Math.random())]+r+"/"+t[0].toString()+"/"+t[1].toString()+"/"+t[2].toString()+".png"};return t.setSource(new ol.source.TileImage({crossOrigin:null,attributions:[new ol.Attribution({html:/^world/.test(r)?"<a href='//mapbox.com'>MapBox</a> | Some Data &copy; OSM CC-BY-SA | <a href='//mapbox.com/tos'>Terms of Service</a>":"<a href='//mapbox.com'>MapBox</a> | <a href='//mapbox.com/tos'>Terms of Service</a>"})],tileGrid:new ol.tilegrid.TileGrid({origin:[-20037508.34,-20037508.34],resolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,.5971642833948135]}),tileUrlFunction:n})),t}if("WMS"===e.type)return new ol.layer.Tile({group:"background",source:new ol.source.TileWMS({url:e.url,params:e.params})});throw new Error("no type for : "+JSON.stringify(e))}}}),a.service("stEditableLayerBuilder",["$q","stAnnotateLayer","stBaseLayerBuilder",function(e,t){return{buildEditableLayer:function(r,n){var a=new o(r),i=e.defer(),s=[],l=!(r.latlonBBOX&&r.times);l&&s.push(t.loadCapabilities(a));var u=!r.attributes;return u&&s.push(t.describeFeatureType(a)),s.push("VECTOR"!==r.type&&"HEATMAP"!==r.type||r.features?t.getStyleName(a):t.getFeatures(a,n)),e.all(s).then(function(){if(a.get("features")){var e=a.get("times");if(e){var t=e.start||e[0];storytools.core.time.maps.filterVectorLayer(a,{start:t,end:t})}else a.getLayer().getSource().addFeatures(a.get("features"))}else a.setWMSSource();i.resolve(a)},function(){i.reject(arguments)}),i.promise}}}]),a.service("stLayerBuilder",["$q",function(e){return{buildLayer:function(t){var o=new r(t),n=e.defer();return o.setWMSSource(),n.resolve(o),n.promise}}}]),a.service("stStoryMapBaseBuilder",["$rootScope","$compile","$http","stBaseLayerBuilder",function(e,t,r,o){return{defaultMap:function(e){e.getMap().setView(new ol.View({center:[0,0],zoom:3,minZoom:3,maxZoom:16})),this.setBaseLayer(e,{title:"World Topo Map",type:"ESRI",name:"world-topo-map"})},setBaseLayer:function(e,t){var r=o.buildLayer(t);e.setBaseLayer(r)}}}]),a.service("stStoryMapBuilder",["$rootScope","$compile","stLayerBuilder","stStoryMapBaseBuilder",function(e,t,r,o){return{modifyStoryMap:function(e,t){e.clear();var n=storytools.mapstory.MapConfigTransformer.MapConfigTransformer(t);n.id>=0&&(e.set("id",n.id),e.setMode(n.playbackMode),void 0!==t.about&&(e.setStoryTitle(t.about.title),e.setStoryAbstract(t.about.abstract),e.setStoryOwner(t.about.owner)),e.setCenter(n.map.center),e.setZoom(n.map.zoom));for(var a=0,i=n.map.layers.length;i>a;++a){var s=n.map.layers[a];"background"===s.group&&s.visibility===!0?o.setBaseLayer(e,s):r.buildLayer(s,e.getMap()).then(function(t){e.addStoryLayer(t)})}e.getMap().setView(new ol.View({center:n.map.center,zoom:n.map.zoom,minZoom:3,maxZoom:17}))}}}]),a.service("stEditableStoryMapBuilder",["$rootScope","$compile","stStoryMapBaseBuilder","stEditableLayerBuilder",function(e,t,r,o){return{modifyStoryLayer:function(e,t){var r=e.getProperties(),n=e.getStoryMap();return r.type=t?t:"WMS"===r.type?"VECTOR":"WMS","WMS"===r.type&&delete r.features,o.buildEditableLayer(r,n.getMap()).then(function(t){e.setLayer(t.getLayer()),e.set("type",t.get("type"))})},modifyStoryMap:function(a,i){a.clear();var s=storytools.mapstory.MapConfigTransformer.MapConfigTransformer(i);s.id>=0&&(a.set("id",s.id),a.setMode(s.playbackMode),void 0!==i.about&&(a.setStoryTitle(i.about.title),a.setStoryAbstract(i.about.abstract),a.setStoryOwner(i.about.owner)));for(var l=0,u=s.map.layers.length;u>l;++l){var c=s.map.layers[l];"background"===c.group&&c.visibility===!0?r.setBaseLayer(a,c):o.buildEditableLayer(c,a.getMap()).then(function(e){a.addStoryLayer(e)})}n(a,e,t),a.getMap().setView(new ol.View({center:s.map.center,zoom:s.map.zoom,projection:s.map.projection,minZoom:3,maxZoom:17}))}}}]);var u=[],c="",p=null,y=null,g=null,m=null,f=null,d=null}(),function(){var e=angular.module("loom_media_service",[]),t=null,r=null,o=null,n=null;e.config(["$sceDelegateProvider",function(e){e.resourceUrlWhitelist(["self",new RegExp(/https?:\/\/.*\.flickr\.com\/photos\/.*/),new RegExp(/https?:\/\/flic\.kr\/p\/.*/),new RegExp(/https?:\/\/instagram\.com\/p\/.*/),new RegExp(/https?:\/\/instagr\.am\/p\/.*/),new RegExp(/https?:\/\/vine\.co\/v\/.*/),new RegExp(/https?:\/\/(?:www\.)?vimeo\.com\/.+/),new RegExp(/https?:\/\/((?:www\.)|(?:pic\.)?)twitter\.com\/.*/),new RegExp(/https?:\/\/(?:w{3}\.)?(?:youtu\.be\/|youtube(?:-nocookie)?\.com).+/im),new RegExp(/https?:\/\/(w{3}\.)?soundcloud\.com\/.+/im),new RegExp(/https?:\/\/(?:((?:m)\.)|((?:www)\.)|((?:i)\.))?imgur\.com\/?.+/im)])}]),e.provider("mediaService",function(){function e(e,t){var r,o="https://noembed.com/embed?url="+e+"&callback=JSON_CALLBACK",n="";for(r in t)null!==t[r]&&(n+="&"+encodeURIComponent(r)+"="+t[r]);return o+=n}function a(t,r){var n=o.defer(),a=e(t,r);return http_.jsonp(a,{headers:{"Content-Type":"application/json"}}).success(function(e){n.resolve(e.html)}),n.promise}function i(e,t){var r=o.defer(),n=/(https?:\/\/(\w+\.)?imgur\.com)/gi,a=e.match(n),i="";if(a.length>1)i='<iframe src="'+e+'" width="'+t.maxwidth+'" height="'+t.maxheight+'"></iframe>';else{var s=/https?:\/\/imgur\.com\/(?:\w+)\/?(.*?)(?:[#\/].*|$)/i;i=e.replace(s,'<blockquote class="imgur-embed-pub" lang="en" data-id="a/$1"></blockquote><script async src="//s.imgur.com/min/embed.js" charset="utf-8"></script>')}return r.resolve(i),r.promise}this.$get=["$rootScope","$http","$q",function(e,a,i){return http_=a,o=i,t=this,http_.jsonp("https://noembed.com/providers?callback=JSON_CALLBACK",{headers:{"Content-Type":"application/json"}}).success(function(e){n=e}),r=t.configureDefaultHandlers(),t}],this.isNOEmbedProvided=function(e){for(var t=0;t<n.length;t+=1)for(var r=n[t],o=0;o<r.patterns.length;o+=1){var a=new RegExp(r.patterns[o],"i");if(null!==e.match(a))return!0}return!1},this.configureDefaultHandlers=function(){var e=[{name:"imgur",regex:/(https?:\/\/(\w+\.)?imgur\.com)/i,callback:i}];return e},this.isUrl=function(e){return/^(f|ht)tps?:\/\//i.test(e)?!0:!1},this.getEmbedContent=function(e,o){for(var n='<a href="'+e+'"> Unable to Embed Content </a>',i=0;i<r.length;i+=1){var s=r[i];if(s.regex.test(e))return s.callback(e,o)}return null!==t.isNOEmbedProvided(e)?a(e,o):n}})}(),function(){"use strict";function e(e){this.storyPins=[],this.map=null,n=e}var t=angular.module("storytools.core.pins",[]),r=storytools.core.maps.pins,o=storytools.core.time.utils,n=null;e.$inject=["$rootScope"],e.prototype.autoDisplayPins=function(e){for(var t=this.storyPins.filter(function(e){return e.get("auto_show")}),r=0;r<t.length;r+=1){var a=t[r],i=o.createRange(a.start_time,a.end_time);i.intersects(e)?n.$broadcast("showPin",a):n.$broadcast("hidePinOverlay",a)}},e.prototype.pinsChanged=function(e,t){var r;if("delete"==t){for(r=0;r<e.length;r++)for(var o=e[r],n=0,a=this.storyPins.length;a>n;n++)if(this.storyPins[n].id==o.id){this.storyPins.splice(n,1);break}}else if("add"==t)for(r=0;r<e.length;r++)this.storyPins.push(e[r]);else if("change"!=t)throw new Error("action? :"+t);var i=this.storyPins.map(function(e){return e.start_time>e.end_time?storytools.core.utils.createRange(e.end_time,e.start_time):storytools.core.utils.createRange(e.start_time,e.end_time)});this.map.storyPinsLayer.set("times",i),this.map.storyPinsLayer.set("features",this.storyPins)},e.prototype.clear=function(){this.storyPins=[],this.map.storyPinsLayer.set("times",[]),this.map.storyPinsLayer.set("features",this.storyPins)},e.prototype.loadFromGeoJSON=function(e,t,o){if(o&&(this.storyPins=[]),e&&e.features){var n=r.loadFromGeoJSON(e,t);this.pinsChanged(n,"add",!0)}},t.service("StoryPinLayerManager",e),t.constant("StoryPin",r.StoryPin),t.service("stAnnotationsStore",["StoryPinLayerManager",function(e){function t(e){return"/maps/"+e+"/annotations"}function r(e){var r=localStorage.getItem(t(e));return r=null===r?[]:JSON.parse(r)}function o(e,r){localStorage.setItem(t(e),(new ol.format.GeoJSON).writeFeatures(r,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}return{loadAnnotations:function(t,o){return e.loadFromGeoJSON(r(t),o)},deleteAnnotations:function(e){var t=r(),n=e.map(function(e){return e.id});t=t.filter(function(e){return n.indexOf(e.id)<0}),o(t)},saveAnnotations:function(e,t){var n=r(),a=0;n.forEach(function(e){a=Math.max(a,e.id)});var i=[];t.forEach(function(e){"undefined"==typeof e.id&&(e.id=++a);var t=e.clone();void 0!==e.get("start_time")&&t.set("start_time",e.get("start_time")/1e3),void 0!==e.get("end_time")&&t.set("end_time",e.get("end_time")/1e3),i.push(t)}),o(e,i)}}}])}(),function(){"use strict";angular.module("storytools.core.style",["storytools.core.style.ol3StyleConverter","storytools.core.style.svgIcon"])}(),function(){"use strict";var e=angular.module("storytools.core.style.ol3StyleConverter",[]);e.factory("ol3MarkRenderer",["ol3StyleConverter",function(e){return function(t,r){var o=e.getColor("#000000"),n=3,a={color:o,width:n},i=angular.element(e.generateShape({symbol:{shape:t,size:r-n}},new ol.style.Fill(a),new ol.style.Stroke(a)).getImage());return i}}]),e.factory("ol3StyleConverter",["stSvgIcon",function(e){return{generateShapeConfig:function(e,t,r){var o=e.symbol.shape,n=e.symbol.size/2;return"circle"===o?{fill:t,stroke:r,radius:n}:"square"===o?{fill:t,stroke:r,points:4,radius:n,angle:Math.PI/4}:"triangle"===o?{fill:t,stroke:r,points:3,radius:n,angle:0}:"star"===o?{fill:t,stroke:r,points:5,radius:n,radius2:.5*n,angle:0}:"cross"===o?{fill:t,stroke:r,points:4,radius:n,radius2:0,angle:0}:"x"===o?{fill:t,stroke:r,points:4,radius:n,radius2:0,angle:Math.PI/4}:void 0},calculateRotation:function(e,t){return e.symbol&&e.symbol.rotationAttribute?"radians"===e.symbol.rotationUnits?t.get(e.symbol.rotationAttribute):t.get(e.symbol.rotationAttribute)/360*Math.PI:void 0},generateShape:function(t,r,o,n){var a=this.generateShapeConfig(t,r,o);if(a&&n&&(a.rotation=this.calculateRotation(t,n)),t.symbol.graphic){var i=e.getImage(t.symbol.graphic,r.getColor(),o.getColor(),!0);return new ol.style.Icon({src:i.dataURI,rotation:this.calculateRotation(t,n),scale:t.symbol.size/Math.max(i.width,i.height),opacity:t.symbol.opacity})}return"circle"===t.symbol.shape?new ol.style.Circle(a):new ol.style.RegularShape(a)},getText:function(e,t){return e.label&&e.label.attribute?""+t.get(e.label.attribute):void 0},generateText:function(e,t,r){return e.label&&null!==e.label.attribute?new ol.style.Text({fill:new ol.style.Fill({color:e.label.fillColor}),stroke:t,font:e.label.fontStyle+" "+e.label.fontWeight+" "+e.label.fontSize+"px "+e.label.fontFamily,text:this.getText(e,r)}):void 0},getColor:function(e,t){var r=ol.color.asArray(e);return void 0!==t&&(r=r.slice(),r[3]=t/100),"rgba("+r.join(",")+")"},generateCacheKey:function(e,t){var r=this.getText(e,t),o=e.classify&&e.classify.attribute?t.get(e.classify.attribute):void 0,n=e.symbol&&e.symbol.rotationAttribute?t.get(e.symbol.rotationAttribute):void 0;return r+"|"+o+"|"+n},generateStyle:function(e,t){var r,o;this.styleCache_||(this.styleCache_={});var n=JSON.stringify(e);if(this.styleCache_[n]){if(this.styleCache_[n].length)return this.styleCache_[n];if(o=this.generateCacheKey(e,t),this.styleCache_[n][o])return this.styleCache_[n][o]}var a;if(e.stroke){var i;"dashed"===e.stroke.strokeStyle?i=[5]:"dotted"===e.stroke.strokeStyle&&(i=[1,2]),a=new ol.style.Stroke({lineDash:i,color:this.getColor(e.stroke.strokeColor,e.stroke.strokeOpacity),width:e.stroke.strokeWidth})}if(e.classify&&null!==e.classify.attribute){for(var s,l=0,u=e.rules.length;u>l;++l){var c=e.rules[l],p=t.get(e.classify.attribute),y=!1;void 0!==c.value?y=p===c.value:c.range&&(y=p>=c.range.min&&p<=c.range.max),y&&(s=this.generateText(e,a,t),"point"===e.geomType&&c.style.symbol.fillColor?r=[new ol.style.Style({text:s,image:this.generateShape(e,new ol.style.Fill({color:c.style.symbol.fillColor}),a,t)})]:"line"===e.geomType&&c.style.stroke.strokeColor?r=[new ol.style.Style({text:s,stroke:new ol.style.Stroke({color:c.style.stroke.strokeColor,width:2})})]:"polygon"===e.geomType&&c.style.symbol.fillColor&&(r=[new ol.style.Style({text:s,stroke:a,fill:new ol.style.Fill({color:c.style.symbol.fillColor})})]))
}r&&(this.styleCache_[n]||(this.styleCache_[n]={}),o=this.generateCacheKey(e,t),this.styleCache_[n][o]=r)}else{var g=new ol.style.Fill({color:this.getColor(e.symbol.fillColor,e.symbol.fillOpacity)});r=[new ol.style.Style({image:this.generateShape(e,g,a,t),fill:g,stroke:a,text:this.generateText(e,a,t)})]}if(r){var m=r[0].getText();m||e.classify&&e.classify.attribute||e.symbol&&e.symbol.rotationAttribute?(this.styleCache_[n]||(this.styleCache_[n]={}),o=this.generateCacheKey(e,t),this.styleCache_[n][o]=r):this.styleCache_[n]=r}return r}}}])}(),function(){"use strict";var e=angular.module("storytools.core.style.svgIcon",[]);e.factory("stSvgIcon",["$cacheFactory","$http","$q","$log",function(e,t,r,o){function n(e,t,r){a.html(e),["path","polygon","circle","ellipse","rect","line","polyline"].forEach(function(e){angular.forEach(a.find(e),function(e){e=angular.element(e);var o={opacity:1},n=e.css("fill")||e.attr("fill")||"";"none"!=n&&"rgb(255, 255, 255)"!=n&&"#ffffff"!=n.toLowerCase()&&(o.fill=t);var a=e.css("stroke")||e.attr("stroke");"none"!=a&&(o.stroke=r),e.css(o)})});var o=a.find("svg"),n=parseInt(o.attr("width")),i=parseInt(o.attr("height"));(isNaN(n)||isNaN(i))&&(o.attr("width",64),o.attr("height",64),n=64,i=64);var s="data:image/svg+xml;base64,"+btoa(a.html());return{dataURI:s,width:n,height:i}}var a=angular.element(document.createElement("div")),i=e("stSvgImage"),s=e("stSvgData");return{getImage:function(e,t,a,l){var u=e+t+a,c=i.get(u),p=r.defer();if(c){if(l)return c;p.resolve(c)}else{if(l){var y=s.get(e);if(y){var g=n(y,t,a);return g.uri=e,i.put(u,g),g}return o.warning("no svg for",e),null}this.getImageData(e).then(function(r){var o=n(r.data,t,a);o.uri=e,i.put(u,o),p.resolve(o)},function(){p.reject("error")})}return p.promise},getImageData:function(e){return t.get(e,{cache:!0}).success(function(t){return s.put(e,t),t}).error(function(){o.warn("error fetching "+e)})}}}])}(),function(){"use strict";var e=angular.module("storytools.core.time.directives",[]);e.directive("stPlaybackControls",function(){return{restrict:"E",templateUrl:"time/playback-controls.html",scope:{timeControls:"=",playbackOptions:"="},link:function(e){e.playbackState="Play",e.loopText="Loop Chapter",e.loopStoryEnabled=!1,e.loopChapterEnabled=!1,e.showTimeLine=!1,e.next=function(){e.timeControls.next()},e.prev=function(){e.timeControls.prev()},e.$watch("timeControls",function(t,r){t!==r&&(t.on("stateChange",function(){var t=e.timeControls.isStarted();e.started=t,e.playbackState=t?"Pause":"Play",e.$apply()}),t.on("rangeChange",function(t){e.currentRange=t,e.$apply()}))}),e.$on("pausePlayback",function(){var t=e.timeControls,r=t.isStarted();r&&t.stop()}),e.play=function(){var t=e.timeControls,r=t.isStarted();r?t.stop():t.start()},e.isInFullScreen=function(e){return void 0!==e.fullScreenElement?!!e.fullScreenElement:void 0!==e.mozFullScreen?!!e.mozFullScreen:void 0!==e.webkitIsFullScreen?!!e.webkitIsFullScreen:void 0!==window.fullScreen?!!window.fullScreen:void 0!==window.navigator.standalone?!!window.navigator.standalone:void 0},e.toggleFullScreen=function(){var e=window.parent.document.getElementById("embedded_map");this.isInFullScreen(document)||this.isInFullScreen(parent.document)?document.mozCancelFullScreen?(parent.document.mozCancelFullScreen(),document.mozCancelFullScreen()):(parent.document.webkitCancelFullScreen(),document.webkitCancelFullScreen()):document.webkitFullScreen&&document.mozFullScreen&&document.msFullscreenElement&&document.fullscreenElement||(e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT))},e.toggleLoop=function(){var t=e.timeControls;"none"===t.loop?(e.loop=t.loop="chapter",e.loopText="Loop Story",e.loopChapterEnabled=!0):"chapter"===t.loop?(e.loop=t.loop="story",e.loopText="Disable Loop",e.loopStoryEnabled=!0,e.loopChapterEnabled=!1):(e.loopText="Loop Chapter",e.loop=t.loop="none",e.loopStoryEnabled=!1,e.loopChapterEnabled=!1)},e.getLoopButtonGlyph=function(){return"story"===e.loop?"glyphicon glyphicon-refresh":"glyphicon glyphicon-repeat"},e.toggleTimeLine=function(){var t=e.timeControls;e.showTimeLine=t.showTimeLine=!t.showTimeLine;var r=$("#timeline");t.showTimeLine?r.show("slow"):r.hide("slow")}}}}),e.directive("stPlaybackSettings",function(){return{restrict:"E",templateUrl:"time/playback-settings.html",scope:{timeControls:"=",playbackOptions:"="},link:function(e){e.optionsChanged=function(){e.timeControls&&e.timeControls.update(e.playbackOptions)}}}})}(),function(){"use strict";var e=angular.module("storytools.core.time",["storytools.core.time.directives","storytools.core.time.services","storytools.core.templates"]);e.filter("isodate",function(){return function(e){return null!==e&&angular.isDefined(e)?angular.isNumber(e)?new Date(e).toISOString():Date.parse(e).toISOString():""}})}(),function(){"use strict";function e(e){function t(e){e=o.getTime(e),null===e||e in n||(n[e]=1)}if(!angular.isArray(e)){var r=e;e=r.getStoryLayers().getArray().filter(function(e){var t=e.get("times");return null!=t}),e.push(r.storyPinsLayer),e.push(r.storyBoxesLayer)}var n={},a=null,i=[];if(e.forEach(function(e){var r,n=e.get("times");angular.isArray(n)?(r=o.computeRange(n),n.length&&n.forEach(o.isRangeLike(n[0])?function(e){t(e.start),null===a?a=o.createRange(e):a.extend(e)}:function(e){t(e)}),null!=r.end&&t(r.end)):n&&(r=n,i.push(n)),null===a?a=o.createRange(r):a.extend(r)}),i.length){i.sort(function(e,t){return e.interval-t.interval});for(var s=i[0],l=a.start;l<=a.end;)t(l),l=s.offset(l)}return n=Object.getOwnPropertyNames(n).map(function(e){return parseInt(e)}),n.sort(function(e,t){return e-t})}function t(t,r,o,n){function a(t){if(null===i.timeControls){var a=e(n.storyMap);if(a.length){var s=o.storyPins;i.timeControls=storytools.core.time.create({annotations:s,storyMap:n.storyMap,storyLayers:n.storyMap.getStoryLayers().getArray(),data:a,mode:n.storyMap.mode,tileStatusCallback:function(e){r.$broadcast("tilesLoaded",e)},chapterCount:n.chapterCount}),i.timeControls.on("rangeChange",function(e){i.currentRange=e,o.autoDisplayPins(e)})}}else if(t){var l=t();l&&i.timeControls.update(l)}}this.timeControls=null;var i=this;n.storyMap.getStoryLayers().on("change:length",function(){a(function(){var t=e(n.storyMap);return t.length>=0?{storyLayers:n.storyMap.getStoryLayers().getArray(),data:t}:void 0})});var s=n.storyMap.storyPinsLayer,l=n.storyMap.storyBoxesLayer;s.on("change:features",function(){a(function(){var t=e(n.storyMap);return t.length?{storyLayers:n.storyMap.getStoryLayers().getArray(),annotations:s.get("features"),boxes:l.get("features"),data:t}:void 0})}),l.on("change:features",function(){a(function(){var t=e(n.storyMap);return t.length?{annotations:s.get("features"),data:t,boxes:l.get("features")}:void 0})}),a()}var r=angular.module("storytools.core.time.services",[]),o=storytools.core.time.utils;r.constant("TimeControlsManager",t),r.service("TimeMachine",function(){return{computeTicks:e}})}(),function(){var e=angular.module("storytools.core.loading.directives",[]);e.directive("stLoading",function(){return{restrict:"C",templateUrl:"loading/loading.html",scope:{spinnerHidden:"="},link:function(e,t,r){e.spinnerWidth=3,e.spinnerRadius=28,goog.isDefAndNotNull(r.spinnerWidth)&&(e.spinnerWidth=parseInt(r.spinnerWidth,10)),goog.isDefAndNotNull(r.spinnerRadius)&&(e.spinnerRadius=parseInt(r.spinnerRadius,10));var o=t.find(".loading");o.css("width",e.spinnerRadius+"px"),o.css("height",e.spinnerRadius+"px"),o.css("margin","-"+e.spinnerRadius/2+"px 0 0 -"+e.spinnerRadius/2+"px");var n=t.find(".loading-spinner");n.css("width",e.spinnerRadius-e.spinnerWidth+"px"),n.css("height",e.spinnerRadius-e.spinnerWidth+"px"),n.css("border",e.spinnerWidth+"px solid"),n.css("border-radius",e.spinnerRadius/2+"px");var a=t.find(".mask");a.css("width",e.spinnerRadius/2+"px"),a.css("height",e.spinnerRadius/2+"px");var i=t.find(".spinner");i.css("width",e.spinnerRadius+"px"),i.css("height",e.spinnerRadius+"px")}}})}(),function(){"use strict";var e=angular.module("storytools.core.measure.directives",[]);e.directive("stMeasurepanel",["$rootScope","MapManager",function(e,t){return{replace:!0,templateUrl:"measure/measurepanel.tpl.html",link:function(e){e.mapManager=t,e.isMeasuring=!1,e.feature=null,e.measureType="",e.source=new ol.source.Vector,e.layer=new ol.layer.Vector({source:e.source}),e.units="m",e.unitTypes=[{type:"m",label:"M/KM"},{type:"mi",label:"Mi"},{type:"ft",label:"Ft"}],e.changeUnits=function(t){e.units=t},e.measureLabel=0,e.unitsLabel="",e.interaction=null;var r=function(t){return new ol.interaction.Draw({source:e.source,type:"line"==t?"LineString":"Polygon"})},o=new ol.Sphere(6378137),n=t.storyMap.getMap().getView().getProjection();e.updateMeasure=function(){var t=e.feature.getGeometry(),r=t.clone().transform(n,"EPSG:4326"),a=[];if(t instanceof ol.geom.Polygon){if(a=r.getLinearRing(0).getCoordinates(),a.length>2){var i=Math.abs(o.geodesicArea(a));i>1e6&&"m"==e.units?(i/=1e6,e.unitsLabel="km^2"):"ft"==e.units?(i=10.7639*i,e.unitsLabel="ft^2"):"mi"==e.units?(i=i/1e3*386102e-9,e.unitsLabel="mi^2"):e.unitsLabel="m^2",e.measureLabel=i,e.feature.set("measureLabel",i),e.$apply()}}else{var s=0;if(a=r.getCoordinates(),a.length>1){for(var l=1,u=a.length;u>l;l++)s+=o.haversineDistance(a[l-1],a[l]);s>1e3&&"m"==e.units?(s/=1e3,e.unitsLabel="km"):"ft"==e.units?(s=3.28084*s,e.unitsLabel="ft"):"mi"==e.units?(s/=1609,e.unitsLabel="mi"):e.unitsLabel="m",e.measureLabel=s,e.feature.set("measureLabel",s),e.$apply()}}},e.startMeasuring=function(o){e.isMeasuring&&e.stopMeasuring(),e.measureType=o,t.storyMap.getMap().addLayer(e.layer),e.interaction=r(o),t.storyMap.getMap().addInteraction(e.interaction),e.interaction.on("drawstart",function(t){e.source.clear(),e.measureLabel=0,e.feature=t.feature,e.feature.set("id","measure-tool"),e.feature.getGeometry().on("change",e.updateMeasure)}),e.isMeasuring=!0},e.stopMeasuring=function(){t.storyMap.getMap().removeLayer(e.layer),e.measureLabel=0,null!==e.interaction&&t.storyMap.getMap().removeInteraction(e.interaction),e.measureType="",e.isMeasuring=!1}}}}])}(),function(){"use strict";angular.module("storytools.core.measure",["storytools.core.measure.directives"])}(),function(){"use strict";var e=angular.module("storytools.core.mapstory.localStorageSvc",[]);e.service("stLocalStorageSvc",["$http",function(){function e(e){return"/maps/"+e}var t={};return t.get=function(t){var r=localStorage.getItem(e(t));return r=null===r?{}:angular.fromJson(r)},t.set=function(t){localStorage.setItem(e(t.id),angular.toJson(t))},t.list=function(){var e=[],t=new RegExp("/maps/(\\d+)$");return Object.getOwnPropertyNames(localStorage).forEach(function(r){var o=t.exec(r);o&&e.push({id:o[1]})}),e},t.nextId=function(){var e=0,r=t.list().map(function(e){return e.id});return r.sort(),r.length&&(e=parseInt(r[r.length-1])),e+1},{listMaps:function(){return t.list()},loadConfig:function(e){return t.get(e)},saveConfig:function(e){angular.isDefined(e.id)||(e.id=t.nextId()),t.set(e)}}}])}(),function(){"use strict";var e=angular.module("storytools.core.mapstory.remoteStorageSvc",[]);e.factory("stRemoteStorageSvc",["$q","$http",function(){this.save=function(){}}])}(),function(){"use strict";angular.module("storytools.core.mapstory.services",["storytools.core.mapstory.localStorageSvc","storytools.core.mapstory.remoteStorageSvc"])}();